<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Monitor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background-color: #4caf50;
        }

        .status-dot.connecting {
            background-color: #ff9800;
        }

        .status-dot.disconnected {
            background-color: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .gauge {
            text-align: center;
            margin-bottom: 20px;
        }

        .gauge-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .gauge-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .gauge-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .gauge-fill.warning {
            background: linear-gradient(90deg, #ff9800 0%, #f44336 100%);
        }

        .gauge-unit {
            color: #999;
            font-size: 12px;
        }

        .recommendation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .recommendation-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .recommendation-text {
            font-size: 24px;
            font-weight: bold;
        }

        .confidence {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.8;
        }

        .water-soon {
            background: linear-gradient(135deg, #ff9800 0%, #f44336 100%);
        }

        .water-now {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
        }

        .dont-water {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .last-update {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 15px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .loading {
            color: #667eea;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .gauge-value {
                font-size: 28px;
            }

            .recommendation-text {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± Plant Monitor Dashboard</h1>
            <div class="header-info">
                <div class="status">
                    <div class="status-dot connecting" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
                <div>Last Update: <span id="lastUpdate">-</span></div>
            </div>
        </header>

        <div id="errorContainer"></div>

        <div class="grid">
            <!-- Recommendation Card -->
            <div class="card">
                <h2>Watering Status</h2>
                <div class="recommendation" id="recommendationBox">
                    <div class="recommendation-title">Current Recommendation</div>
                    <div class="recommendation-text" id="recommendation">-</div>
                    <div class="confidence">
                        Confidence: <span id="confidence">-</span>
                    </div>
                </div>
            </div>

            <!-- Soil Moisture -->
            <div class="card">
                <h2>Soil Moisture</h2>
                <div class="gauge">
                    <div class="gauge-label">Moisture Level</div>
                    <div class="gauge-value" id="soilMoisture">-</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="soilMoistureFill" style="width: 0%"></div>
                    </div>
                    <div class="gauge-unit">0% - 100%</div>
                </div>
            </div>

            <!-- Temperature -->
            <div class="card">
                <h2>Temperature</h2>
                <div class="gauge">
                    <div class="gauge-label">Current Temperature</div>
                    <div class="gauge-value" id="temperature">-</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="temperatureFill" style="width: 0%"></div>
                    </div>
                    <div class="gauge-unit">10¬∞C - 35¬∞C</div>
                </div>
            </div>

            <!-- Humidity -->
            <div class="card">
                <h2>Humidity</h2>
                <div class="gauge">
                    <div class="gauge-label">Air Humidity</div>
                    <div class="gauge-value" id="humidity">-</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="humidityFill" style="width: 0%"></div>
                    </div>
                    <div class="gauge-unit">0% - 100%</div>
                </div>
            </div>

            <!-- Light Level -->
            <div class="card">
                <h2>Light Level</h2>
                <div class="gauge">
                    <div class="gauge-label">Light Intensity</div>
                    <div class="gauge-value" id="lightLevel">-</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="lightLevelFill" style="width: 0%"></div>
                    </div>
                    <div class="gauge-unit">0% - 100%</div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>Statistics</h2>
                <div class="stat">
                    <span class="stat-label">Total Readings</span>
                    <span class="stat-value" id="totalReadings">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Water Now Count</span>
                    <span class="stat-value" id="waterNowCount">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Water Soon Count</span>
                    <span class="stat-value" id="waterSoonCount">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Don't Water Count</span>
                    <span class="stat-value" id="dontWaterCount">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://172.16.255.237:5000';
        const UPDATE_INTERVAL = 5000; // 5 seconds

        // State
        let lastUpdateTime = null;
        let isConnected = false;

        // Helper function to update gauge display
        function updateGauge(valueElement, fillElement, value, min, max, unit = '') {
            const percentage = ((value - min) / (max - min)) * 100;
            valueElement.textContent = Math.round(value) + unit;
            fillElement.style.width = Math.max(0, Math.min(100, percentage)) + '%';
        }

        // Helper function to format timestamp
        function formatTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString();
            } catch {
                return '-';
            }
        }

        // Update dashboard with latest data
        async function updateDashboard() {
            try {
                // Fetch latest readings
                const latestResponse = await fetch(`${API_BASE_URL}/api/latest`);
                if (!latestResponse.ok) throw new Error('Failed to fetch latest data');
                const latest = await latestResponse.json();

                // Fetch sensor metrics
                const metricsResponse = await fetch(`${API_BASE_URL}/api/sensor-metrics`);
                if (!metricsResponse.ok) throw new Error('Failed to fetch metrics');
                const metrics = await metricsResponse.json();

                // Fetch recommendation
                const recResponse = await fetch(`${API_BASE_URL}/api/recommendation`);
                if (!recResponse.ok) throw new Error('Failed to fetch recommendation');
                const recommendation = await recResponse.json();

                // Fetch statistics
                const statsResponse = await fetch(`${API_BASE_URL}/api/statistics`);
                if (!statsResponse.ok) throw new Error('Failed to fetch statistics');
                const stats = await statsResponse.json();

                // Update sensors
                if (metrics) {
                    updateGauge(
                        document.getElementById('soilMoisture'),
                        document.getElementById('soilMoistureFill'),
                        metrics.soil_moisture || 0,
                        0,
                        100,
                        '%'
                    );

                    updateGauge(
                        document.getElementById('temperature'),
                        document.getElementById('temperatureFill'),
                        metrics.temperature || 0,
                        10,
                        35,
                        '¬∞C'
                    );

                    updateGauge(
                        document.getElementById('humidity'),
                        document.getElementById('humidityFill'),
                        metrics.humidity || 0,
                        0,
                        100,
                        '%'
                    );

                    updateGauge(
                        document.getElementById('lightLevel'),
                        document.getElementById('lightLevelFill'),
                        metrics.light_level || 0,
                        0,
                        100,
                        '%'
                    );
                }

                // Update recommendation
                if (recommendation) {
                    const recBox = document.getElementById('recommendationBox');
                    const recText = recommendation.recommendation || '-';
                    
                    // Apply styling based on recommendation
                    recBox.className = 'recommendation';
                    if (recText.includes('Water Now')) {
                        recBox.classList.add('water-now');
                    } else if (recText.includes('Water Soon')) {
                        recBox.classList.add('water-soon');
                    } else {
                        recBox.classList.add('dont-water');
                    }

                    document.getElementById('recommendation').textContent = recText;
                    document.getElementById('confidence').textContent = 
                        Math.round((recommendation.confidence || 0) * 100) + '%';
                }

                // Update statistics
                if (stats) {
                    document.getElementById('totalReadings').textContent = stats.total_readings || 0;
                    document.getElementById('waterNowCount').textContent = 
                        stats.recommendations?.water_now || 0;
                    document.getElementById('waterSoonCount').textContent = 
                        stats.recommendations?.water_soon || 0;
                    document.getElementById('dontWaterCount').textContent = 
                        stats.recommendations?.dont_water || 0;
                }

                // Update status
                setConnected(true);
                lastUpdateTime = new Date();
                updateLastUpdateTime();

                // Clear error messages
                document.getElementById('errorContainer').innerHTML = '';

            } catch (error) {
                setConnected(false);
                showError('Failed to fetch data: ' + error.message);
            }
        }

        // Set connection status
        function setConnected(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        // Show error message
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }

        // Update last update time display
        function updateLastUpdateTime() {
            if (lastUpdateTime) {
                document.getElementById('lastUpdate').textContent = 
                    lastUpdateTime.toLocaleTimeString();
            }
        }

        // Initialize and set up auto-update
        function init() {
            updateDashboard();
            setInterval(updateDashboard, UPDATE_INTERVAL);
            setInterval(updateLastUpdateTime, 1000);
        }

        // Start on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
